<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Search with JavaScript</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js"
        integrity="sha512-AI5A3zIoeRSEEX9z3Vyir8NqSMC1pY7r5h2cE+9J6FLsoEmSSGLFaqMQw8SWvoONXogkfFrkQiJfLeHLz3+HOg=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <style>
        #togglePadding {
            height: 60vh;
            display: none;
        }

        .has-tag {
            outline: 1px solid rgb(202, 202, 202);
        }

        .default-bg {
            position: relative;
            color: #111;
        }

        .default-bg::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #F1F3F4;
            z-index: -1;
            outline: 1px solid #DBDDE1;
            border-radius: 2px;
        }
    </style>
</head>

<body>

    <div class="content-container">
        <div id="pageContent">

            <div class="search-container">
                <input type="text" id="searchInput" placeholder="What are you looking for?">
                <div id="clearInputButton">Ã—</div>
            </div>

            <div id="searchResults"></div>

            <table id="blockTable">
                <tbody>
                    <!-- This tbody will be filled with JavaScript -->
                </tbody>
            </table>
            <div id="togglePadding"></div>
        </div>

        <div id="blockDetails"></div>
    </div>

    <div id="loadingIcon" class="loading-icon-container">
        <div class="loading-circle"></div>
    </div>

    <!-- ===================== JavaScript ===================== -->

    <script src="data.js"></script> <!-- External JavaScript doc that stores tags for respective block numbers -->

    <script>

        let currentHighlightedCell = null; // remove highlight on result item click

        function createTable() { // Generate the html table 9 columns wide
            const tableBody = document.getElementById('blockTable').querySelector('tbody');
            let html = '';
            let counter = 0;

            for (let i = 0; i < Math.ceil(2016 / 9); i++) {
                html += '<tr>';
                for (let j = 0; j < 9 && counter <= 2015; j++) {
                    // Check if the current cell/block number has a tag
                    const hasTag = tagsData.some(entry => entry.block == counter);
                    html += `<td id="block_${counter}" class="${hasTag ? 'default-bg' : ''}"><div class="content">${counter}</div></td>`;
                    counter++;
                }
                html += '</tr>';
            }
            tableBody.innerHTML = html;
        }

        //---------------

        function removeHighlightFromAllCells() {
            for (let i = 0; i <= 2015; i++) {
                const cell = document.getElementById(`block_${i}`);
                cell.classList.remove('highlightClick', 'highlightSearchResult');
            }
        }

        //---------------

        function highlightCellOnClick() {
            for (let i = 0; i <= 2015; i++) {
                const cell = document.getElementById(`block_${i}`);
                cell.addEventListener('click', function () {
                    if (currentHighlightedCell) {
                        currentHighlightedCell.classList.remove('highlightClick');
                    }
                    cell.classList.add('highlightClick');
                    currentHighlightedCell = cell;
                    displayBlockDetails(i);

                    scrollUpFromBehind(cell); //reveal cell location from behind block display div

                });
            }
        }

        // displays block details of a clicked cell 

        function displayBlockDetails(blockNumber) {
            const blockDetailDiv = document.getElementById('blockDetails');

            // Ensure the div is visible before displaying details
            blockDetailDiv.style.display = 'block';

            ShiftUpTable(); // add margin to page bottom when blockDisplay div is open

            const item = data.find(entry => entry.title === `${blockNumber}.bitmap`);

            if (item) {
                const tagsEntry = tagsData.find(entry => entry.block == blockNumber);
                const tagsString = tagsEntry ? `<p>Tags: ${tagsEntry.tags.join(', ')}</p>` : '';

                // Extract image URL from the tagsData entry
                let imageUrl = '';
                if (tagsEntry && tagsEntry.imageUrl) {
                    imageUrl = tagsEntry.imageUrl;
                }

                // Extract image URL from the tagsData entry
                let ownerUsername = '';
                if (tagsEntry && tagsEntry.ownerUsername) {
                    ownerUsername = tagsEntry.ownerUsername;
                }

                // Extract YouTube from the tagsData entry
                let YTUrl = '';
                if (tagsEntry && tagsEntry.YTUrl) {
                    YTUrl = tagsEntry.YTUrl;
                }

                let YTimage = '';
                if (tagsEntry && tagsEntry.YTimage) {
                    YTimage = tagsEntry.YTimage;
                }

                // Extract Twitter from the tagsData entry
                let TwitterUrl = '';
                if (tagsEntry && tagsEntry.TwitterUrl) {
                    TwitterUrl = tagsEntry.TwitterUrl;
                }

                let TwitterImage = '';
                if (tagsEntry && tagsEntry.TwitterImage) {
                    TwitterImage = tagsEntry.TwitterImage;
                }

                // Extract website from the tagsData entry
                let websiteUrl = '';
                if (tagsEntry && tagsEntry.websiteUrl) {
                    websiteUrl = tagsEntry.websiteUrl;
                }

                let websiteImage = '';
                if (tagsEntry && tagsEntry.websiteImage) {
                    websiteImage = tagsEntry.websiteImage;
                }

                const hasSocialLinks = YTimage || TwitterImage;

                blockDetailDiv.innerHTML = `
                <div id="closeButton"><img src="images/down-icon.png"></div>
                <div class="resultItem">
                    ${imageUrl ? `<img src="${imageUrl}" alt="${item.title} image" class="blockImage">` : ''}

                    <div class="owner-username">${ownerUsername}</div>
                    <div class="itemTitle">${item.title}</div>
                    <div class="itemAddressContainer">
                        <img src="images/copy-icon.png" class="copy-icon" onclick="copyText()">
                        <div id="text-to-copy" class="itemAddress">${item.content}</div>
                    </div>
                    <div class="itemTags">${tagsString}</div>

                <div class="logo-list">
                    ${hasSocialLinks ? '<div class="link-title">Socials</div>' : ''}
                    <div class="social-links">
                        <a href="${websiteUrl}" target="_blank">${websiteImage ? `<img src="${websiteImage}" alt="" class="blockdetaillogoicon">` : ''}</a>
                        <a href="${YTUrl}" target="_blank">${YTimage ? `<img src="${YTimage}" alt="" class="blockdetaillogoicon">` : ''}</a>
                        <a href="${TwitterUrl}" target="_blank">${TwitterImage ? `<img src="${TwitterImage}" alt="" class="blockdetaillogoicon">` : ''}</a>
                    </div>
                    <div class="link-title">Bapp Integrations</div>
                    <div class="bapp-links">
                        <a href="https://bitmap.rcsv.io/?r=${blockNumber}" target="_blank"><img src="logos/bapps/rcsv-logo.png" class="blockdetaillogoicon"></a>
                        <a href="https://mscribe.io/block/${blockNumber}" target="_blank"><img src="logos/bapps/mscribe-logo.png" class="blockdetaillogoicon"></a>
                        <a href="https://bitmap.community/analyzer/${blockNumber}" target="_blank"><img src="logos/bapps/bitmapcommunity.png" class="blockdetaillogoicon"></a>
                        <a href="https://bitlords.land/block/${blockNumber}" target="_blank"><img src="logos/bapps/bitlords-logo.png" class="blockdetaillogoicon"></a>
                        <a href="https://magiceden.io/ordinals/item-details/${item.id}" target="_blank"><img src="logos/bapps/ME-logo.png" class="blockdetaillogoicon"></a>
                        <a href="https://ordinalswallet.com/inscription/${item.id}" target="_blank"><img src="logos/bapps/OW-logo.png" class="blockdetaillogoicon"></a>
                    </div>
                </div>
            </div>
        `;


                document.getElementById('closeButton').addEventListener('click', function () {
                    document.getElementById('blockDetails').style.display = 'none';
                    ShiftDownTable(); // Shift back down table upon close of BlockDetails div
                });

            } else {
                blockDetailDiv.innerHTML = '<p>Details loading. No details available for this block.</p>';
            }
        }

        //---------------

        function noHighlightClearAllOnClick() { //if newly clicked cell has no highlight, then clear all highlights
            for (let i = 0; i <= 2015; i++) {
                const cell = document.getElementById(`block_${i}`);
                cell.addEventListener('click', function () {
                    // Check if the cell has a highlight (using classList.contains() or style.backgroundColor)
                    if (!cell.classList.contains('highlightSearchResult') && cell.style.backgroundColor !== 'green') {
                        removeHighlightFromAllCells()
                    }
                });
            }
        }

        // Initializing functions
        createTable();
        noHighlightClearAllOnClick()
        highlightCellOnClick();

        ////========================================

       
        const data = [];
const trac = io("https://bitmap.trac.network", {
    // ... your existing config
});

let tempIds = {};  
let totalQueries = 0;
let receivedResponses = 0;

// Show the loading icon initially
document.getElementById('loadingIcon').style.display = 'flex'; 

trac.on('response', function (msg) { 
    if (msg.func === 'inscribedBitmaps') {
        for (let block in msg.result) {
            if (msg.result[block] && msg.result[block].id) {
                tempIds[block] = msg.result[block].id;
                trac.emit('get', {
                    func: 'ownerOf',
                    args: [msg.result[block].id],
                    call_id: block
                });
                totalQueries++; // Increment the count of total queries sent
            }
        }
    } else if (msg.func === 'ownerOf' && msg.result && msg.result.address) {
        const id = tempIds[msg.call_id];
        if (id) {
            data.push({
                id: id,
                title: `${msg.call_id}.bitmap`,
                content: `${msg.result.address}`,
            });
            delete tempIds[msg.call_id];
        }
        receivedResponses++; // Increment the count of received responses

        // Check if all responses have been received
        if (receivedResponses === totalQueries) {
            document.getElementById('loadingIcon').style.display = 'none';
        }
    }
});


        const CHUNK_SIZE = 200;
        for (let i = 0; i <= 2015; i += CHUNK_SIZE) {
            let end = Math.min(i + CHUNK_SIZE - 1, 2015);
            let blocks = [];
            for (let j = i; j <= end; j++) {
                blocks.push(j);
            }
            trac.emit('get', {
                func: 'inscribedBitmaps',
                args: [blocks],
                call_id: ''
            });
        }

        

        //-----------------

        function getCellForBlock(blockNumber) { // Utility function to map block number to its cell
            return document.getElementById(`block_${blockNumber}`);
        }


        //--------------------

        function highlightBlock(item) {
            if (!item || !item.title) return;

            const blockNumber = item.title.split(".")[0];
            const cell = getCellForBlock(blockNumber);
            if (cell) {
                cell.classList.add('highlightSearchResult');  // Add the highlightSearchResult class to the cell
            }

            // ... any other logic specific to highlighting the block ...
        }

        //--------------------

        function performSearch() {
            removeHighlightFromAllCells(); // Reset highlights
            restoreSearchResults(); // restore searchResults div if minimized on new search

            document.getElementById('blockDetails').style.display = 'none'; // hide block details from cell click

            const query = document.getElementById('searchInput').value.toLowerCase();

            // Check if the search query is empty or just whitespace
            if (!query.trim()) {
                return;  // Exit the function early if the condition is met
            }

            const tokens = query.split(' ').filter(token => token.trim() !== '');
            const resultsDiv = document.getElementById('searchResults');

            // Initialize results Html with an empty string for now
            let resultsHtml = '';

            for (let item of data) {
                const titleMatches = tokens.every(token => item.title.toLowerCase().includes(token));
                const contentMatches = query.length > 7 && tokens.every(token => item.content.toLowerCase().includes(token));
                const tagEntry = tagsData.find(entry => entry.block == item.title.split(".")[0]);
                const tagMatches = tagEntry ? tokens.some(token => tagEntry.tags.map(tag => tag.toLowerCase()).includes(token)) : false;

                if (titleMatches || contentMatches || tagMatches) {
                    highlightBlock(item);

                    const blockNumber = item.title.split(".")[0];
                    document.getElementById(`block_${blockNumber}`).classList.add('highlightSearchResult');
                    const tagsString = tagEntry ? `<p>Tags: ${tagEntry.tags.join(', ')}</p>` : '';

                    // Extract the image URL from the tagsData entry
                    let imageUrl = '';
                    if (tagEntry && tagEntry.imageUrl) {
                        imageUrl = tagEntry.imageUrl;
                    }

                    // Extract the owner username from the tagsData entry
                    let ownerUsername = '';
                    if (tagEntry && tagEntry.ownerUsername) {
                        ownerUsername = tagEntry.ownerUsername;
                    }

                    resultsHtml += `
    <div class="resultItem">
        ${imageUrl ? `<img src="${imageUrl}" alt="${item.title} image" class="blockImage">` : ''}
        <div class="owner-username">${ownerUsername}</div>
        <div class="itemTitle">${item.title}</div>
        <!-- <div class="itemAddress">${item.content}</div> -->
        <div class=itemTags>${tagsString}</div>
    </div>
`;
                }
            }

            if (resultsHtml) { // After the loop, check if any results were added.
                resultsHtml = '<div id="swipeBar"><img src="images/down-icon.png"></div>' + resultsHtml;  // If there were results, prepend the title.
            } else {
                resultsHtml = '<p>Sorry, no results found.</p>'; // If no results, display the error message.
            }
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = resultsHtml; // Display the results

            ShiftUpTable(); // add margin to page bottom when blockDisplay div is open

            // minimize/max search results on toggle click
            const swipeBar = document.getElementById('swipeBar');
            swipeBar.addEventListener('click', toggleSearchResults);


            // Add click event listeners to result items
            document.querySelectorAll('.resultItem').forEach(itemDiv => {
                itemDiv.addEventListener('click', function () {
                    const blockNumber = this.querySelector('.itemTitle').textContent.split('.')[0];
                    displayBlockDetails(blockNumber);

                    // Remove the highlight from the previously highlighted cell
                    if (currentHighlightedCell) {
                        currentHighlightedCell.classList.remove('highlightClick');
                    }

                    // Highlight the clicked result's block in the table with a red background
                    const cell = getCellForBlock(blockNumber);
                    if (cell) {
                        cell.classList.add('highlightClick');
                        currentHighlightedCell = cell;  // Update the currentHighlightedCell variable
                    }


                    // Scroll to the clicked result's block in the table
                    scrollToResultItem(blockNumber);
                });
            });

            // Scroll to the first search result
            scrollToFirstSearchResult(resultsDiv);

            // The rest of the logic that was inside the loop:
            // Add click event listeners, scroll to first result, etc.
            //...
        }


        // ============== Scroll ==============

        // Utility function to calculate the distance from the viewport's bottom
        function distanceFromViewportBottom(element) {
            const rect = element.getBoundingClientRect();
            return window.innerHeight - rect.bottom;
        }

        // Scroll to 1/2 avail screen on table cell click
        function scrollUpFromBehind(cell) {
            const blockDetailsHeight = document.getElementById('blockDetails').offsetHeight;
            const rect = cell.getBoundingClientRect();

            const scrollPosition = rect.top + window.pageYOffset -
                ((window.innerHeight - blockDetailsHeight - rect.height) / 2);

            window.scrollTo({ top: scrollPosition, behavior: 'smooth' });
        }

        // Scrolls to 1/2 avail screen on searchResult
        // Modified for Android virtual keyboard issues
        function scrollToSearchResult(blockNumber) {
            const cell = getCellForBlock(blockNumber);
            if (!cell) return;

            cell.scrollIntoView(true); // Scroll the cell into view

            const cellPosition = cell.getBoundingClientRect();
            const desiredOffset = window.innerHeight * 0.2;

            const currentScrollPosition = window.scrollY || window.pageYOffset; // Calculate the current scroll position

            let newScrollPosition;

            if (cellPosition.top < desiredOffset) { // Check if the top of the cell is above the desired 25% mark
                const difference = desiredOffset - cellPosition.top;
                newScrollPosition = currentScrollPosition - difference;
            } else {
                const spaceBelow = document.documentElement.scrollHeight - (currentScrollPosition + window.innerHeight); // Calculate the remaining space below the item to the bottom of the page

                const actualOffset = Math.min(desiredOffset, spaceBelow);  // Determine the actual offset to scroll by
                newScrollPosition = currentScrollPosition + actualOffset;
            }

            window.scrollTo({ // Use scrollTo with smooth behavior
                top: newScrollPosition,
                behavior: 'smooth'
            });
        }

        // Scrolls to 1/2 avail screen on searchResult item click
        function scrollToResultItem(blockNumber) {
            const cell = getCellForBlock(blockNumber);
            const blockDetailsHeight = document.getElementById('blockDetails').offsetHeight;

            if (cell) {
                const rect = cell.getBoundingClientRect();
                const scrollPosition = rect.top + window.pageYOffset - ((window.innerHeight - blockDetailsHeight) / 2);
                window.scrollTo({ top: scrollPosition, behavior: 'smooth' });
            }
        }

        // Scroll to the first search result
        function scrollToFirstSearchResult(resultsDiv) {
            const firstResult = resultsDiv.querySelector('.resultItem .itemTitle');
            if (!firstResult) return;

            const firstBlockNumber = firstResult.textContent.split('.')[0];
            scrollToSearchResult(firstBlockNumber);
        }


        // ============== Table shift for searchResults div and blockDetail div ==============

        // Shift the page content up by the height of the blockDetailDiv using the toggle padding div (50% viewport height)
        function ShiftUpTable(clickedCell) {
            const togglePadding = document.getElementById('togglePadding');
            togglePadding.style.display = `block`;
        }

        // shift page content back down
        function ShiftDownTable() {
            const togglePadding = document.getElementById('togglePadding');
            togglePadding.style.display = 'none';  // Reset the transform
        }


        // ============== Search Bar ==============

        document.getElementById('searchInput').addEventListener('keydown', function (event) { //Pressing enter submits query
            if (event.key === 'Enter') {
                performSearch();
            }
        });

        // hide keyboard after user submits address
        const searchInput = document.getElementById('searchInput');
        searchInput.addEventListener('keyup', function (event) {
            if (event.key === 'Enter' || event.keyCode === 13) {
                searchInput.blur();  // This will remove focus from the input and close the keyboard
            }
        });

        // Show "x" button when the user types an input in the search bar
        document.getElementById('searchInput').addEventListener('input', function () {
            const clearButton = document.getElementById('clearInputButton');
            if (this.value.trim()) {
                clearButton.style.display = 'block';
            } else {
                clearButton.style.display = 'none';
            }
        });

        // event listener for "x" button next to search bar
        document.getElementById('clearInputButton').addEventListener('click', clearInput);

        // clear search bar input and table cell highlights when search bar "x" is clicked   
        function clearInput() {
            document.getElementById('searchInput').value = '';

            removeHighlightFromAllCells(); // Remove highlights and searched-block class from all cells

            document.getElementById('searchResults').style.display = 'none'; // Remove search results div
            document.getElementById('blockDetails').style.display = 'none'; // Remove block details from cell click
            document.getElementById('clearInputButton').style.display = 'none'; // hide the "x" button after it is clicked
            ShiftDownTable();
        }


        // ============== searchResults Toggle ==============

        // hide search results list on click
        function minimizeSearchResults() {
            const searchResultsDiv = document.getElementById('searchResults');
            searchResultsDiv.classList.add('minimized');
            ShiftDownTable();
        }

        // show search results list on click
        function restoreSearchResults() {
            const searchResultsDiv = document.getElementById('searchResults');
            searchResultsDiv.classList.remove('minimized');
        }

        //Call show and hide functions
        function toggleSearchResults() {
            const searchResultsDiv = document.getElementById('searchResults');

            if (searchResultsDiv.classList.contains('minimized')) {
                restoreSearchResults();
            } else {
                minimizeSearchResults();
            }
        }

        // ============== Copy Address Icon ==============

        function copyText() {
            const textElement = document.getElementById('text-to-copy');
            const selection = window.getSelection();
            const range = document.createRange();

            // Create a range (selection) for the text element
            range.selectNodeContents(textElement);
            selection.removeAllRanges();
            selection.addRange(range);

            // Try copying the selected text
            try {
                document.execCommand('copy');
            } catch (err) {
                console.error('Failed to copy text', err);
            }

            // Remove the selection after copying
            selection.removeAllRanges();
        }


    </script>

</body>

</html>